---
title: "TOUCH-BRAIN: Pre-Registration Plan"
author: "Phuc TU Nguyen"
date: "2025-06-06"

output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: true
    toc_depth: 3
    number_sections: true
    collapse: true
---

```{r setup, warning=FALSE, echo=FALSE, message=FALSE}
## Set up libraries and define paths

rm(list = ls())
library(rstudioapi)

script_path <- dirname(rstudioapi::getActiveDocumentContext()$path)
function_path <- file.path(script_path, "function")

source(file.path(function_path, "loadconfig.R"))
load_lib()
load_path(script_path)
load_palette()

vps <- c("P0")

```


# Pool data {.hidden .unlisted}
<font size="1"> Behavioral and EEG data are merged across all participants and blocks. Block number and trial number are assigned per condition (t/m &times; a/p &times; unimodal/both) </font>

```{r warning=FALSE, message=FALSE, echo=FALSE}
source(file.path(function_path, "loaddata.R"))

# BEH ----
beh_combined_df <- load_behdata(vps, pathlist$beh_data_path)
beh_combined_df <- adjust_beh_df(beh_combined_df)
# Test for sufficient blocks
beh_test <- beh_combined_df %>%
  group_by(NAME, QUESTION, ACTIVE, unimodal) %>%
  summarise(ntrial_beh = n(), .groups = "drop")

# EEG ----
eeg_combined_df <- load_eegdata(vps, pathlist$eeg_data_path)
eeg_combined_df <- adjust_eeg_df(eeg_combined_df)

# Test for sufficient blocks
eeg_test <- eeg_combined_df %>%
  group_by(NAME, QUESTION, ACTIVE, unimodal) %>%
  summarise(ntrial = n(), .groups = "drop")
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
# Compare trial counts between behavioral and EEG data
testmerge <- left_join(beh_test, eeg_test,
  by = c("NAME", "QUESTION", "ACTIVE", "unimodal")
) %>%
  arrange(NAME, unimodal, QUESTION, ACTIVE) %>%
  mutate(trialdiff = ntrial_beh - ntrial)

# Merge full behavioral and EEG datasets
merge_df <- left_join(beh_combined_df, eeg_combined_df,
  by = c("NAME", "QUESTION", "ACTIVE", "unimodal", "trial_number")
)

```

<font size="1">

- P03: touch_passive Block 3

</font>

```{r warning=FALSE, message=FALSE, echo=FALSE}
# Remove specific blocks for specific subjects
merge_df <- merge_df %>%
  filter(!(NAME == "P03" & is.na(unimodal) & QUESTION == "t" & ACTIVE == "p" & BLOCK %in% c(3)))

```

```{r warning=FALSE, message=FALSE, echo=FALSE}
# Export merged data to Excel
xlsx_name <- format(Sys.time(), "BEH_EEG_Data_%d%m%Y.xlsx")
write_xlsx(merge_df, file.path(pathlist$result_path, xlsx_name))
```


## Load and preprocess raw data 
```{r warning=FALSE, message=FALSE, echo=FALSE}
xlsx_name <- format(Sys.time(), "BEH_EEG_Data_%d%m%Y.xlsx")
source(file.path(function_path, "preprocessdata.R"))
channels <- expand.grid(c("F", "Fc", "FC", "C", "CP", "P"), c("3", "5", "z", "4", "6"))
channels <- paste0(channels$Var1, channels$Var2)
```

**Target Length**: based on the task type (touchLength or movLength is selected).

**Condition Labels (condN)**: (1) Self-touch Active - Judge Touch, 
(2) Self-touch Passive - Judge Touch, 
(3) Self-touch Active - Judge Move, 
(4) Self-touch Passive - Judge Move*, 
(5) Unimodal - Judge Touch, 
(6) Unimodal Active - Judge Move, 
(7) Unimodal Passive - Judge Move. 

**Flipped Gain**: Calculated as $|\frac{TargetLength}{InterferenceLength}\ |$.

**Absolute Error**: Calculated as $|1-\frac{ReportedLength}{TargetLength}\ |$.

```{r layout="l-body-outset", fig.width=4, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
rawData <- read_excel(path = file.path(pathlist$result_path, xlsx_name))
rawData <- preprocess_beh_df(rawData) %>%
  select(
    sbjN, trialN, task, mov, unimodal, condN, BLOCK, trial_number,
    gain, flipped.gain, touchLength, movLength, Target_length, Interference_length, resp, estError, absError, delta,
    starts_with(channels)
  )

# Check number of trials per blk per ppt per phase
test <- rawData %>% count(sbjN, condN)

rawData %>%
  select(sbjN, condN, BLOCK, trialN, flipped.gain, Target_length, resp, C3_movcue, C4_movcue, C3_pre, C4_pre, C3_early, C4_early, C3_half, C4_half, C3_late, C4_late, C3_post, C4_post) %>%
  arrange(sbjN, condN, BLOCK, trialN) %>%
  rmarkdown::paged_table(options = list(rows.print = 10, cols.print = 9))

```

```{r warning=FALSE, message=FALSE, echo=FALSE}
# EEG ----
# Make long data

longrawData <- long_beh_eeg_df(rawData)

longData <- filter_outliers(df = longrawData, value_col = "powerBeta", group_cols = c("channellocation_timing"))

shortData <- short_beh_eeg_df(longData %>% select(sbjN:powerBeta)) %>%
  mutate(unimodal = as.factor(unimodal))

shortData.beh = shortData %>%
  filter(!is.na(C3_early) & !is.na(C4_early))
```

\newpage
# Research questions
```{r fig.width=14, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE}
source(file.path(function_path, "reformvariable.R"))

aveData <- ave_df(rawData)
wide.aveData <- ave_wide_df(aveData)

ggplot(aveData, aes(x = Target_length, y = response, color = factor(gain), group = gain)) +
  geom_point(stat = "summary", size = 2) +
  geom_line(stat = "summary", size = 1, show.legend = FALSE) +
  stat_summary(fun.data = "mean_se", geom = "ribbon", aes(fill = factor(gain)), alpha = 0.2, show.legend = FALSE) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
  facet_grid(unimodal ~ task + mov) + # Organize by subject (rows) and hand/task/mov (columns)
  ylim(2, 14) +
  scale_y_continuous(breaks = seq(2, 12, by = 2)) + # Set y-axis ticks at intervals of 2
  xlim(2, 10) +
  labs(x = "Actual target extent (cm)", y = "Perceived target extent (cm)", color = "Gain") +
  scale_color_manual(values = palette$three.color1)+
  scale_fill_manual(values = palette$three.color1)+
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16)
  )
```

## Replication: Asymmetric bidirectional interference
We will replicate the asymmetrical bidirectional interference of movement and tactical spatial percepts in Cataldo et al. (2022):
<p style="text-align: justify;">
**Q1: During self-touch, is there an asymmetric interference of movement and touch on tactile and motor spatial percepts, respectively?**

H1: The interference coefficients (ICs) of task-irrelevant information are significantly larger when participants judge touch compared to movement.
</p>

## Replication: Active vs. Passive Movement
<p style="text-align: justify;">
**Q2: During self-touch, is the asymmetric interference during self-touch larger in active movement than in passive movement?**

H2: ICs are significantly larger when participants are in active movement conditions than in passive movement conditions.**
</p>

## Replication: Self-touch vs. Unimodal
<p style="text-align: justify;">
**Q3: Does interference occur when either motor or tactile information is available?**

H3: ICs are significantly larger than 0 (zero) in self-touch conditions but not unimodal conditions.
</p>

<center style="color:#15925E;">**ICs across conditions**</center>

```{r fig.width=14, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE}
w <- weight_df(shortData)
wide.w <- weight_wide_df(w)

ggplot(w, aes(x = condN, y = weights, fill = condN)) +
  geom_bar(stat = "summary", show.legend = FALSE) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +
  facet_wrap(~ unimodal, scale = "free_x") +
  ylim(0, 1) +
  xlab("Condition") +
  ylab("Weigth of task-irrelevant information (Ï‰)") +
  scale_fill_manual(values = palette$eight.color)+
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 13),
    axis.title = element_text(size = 16)
  )
```


\newpage
## Unimodal: Neural marker for motor and tactile processing

Beta ERD *(i.e., a decrease in beta band power)* over contralateral motor cortex is observed before and during movement, while beta ERS *(i.e., a subsequent increase in power)* occurs after movement completion (Doyle et al., 2005; Stolk et al., 2019). Beta suppression at central scalp sites is also associated with long touch (Von Mohr et al., 2018) and typically reported in the contralateral somatosensory cortex (Singh et al., 2014; Valenza et al., 2018). We will replicate the results that beta power is reduced during movement and touch in the contralateral EEG channel position (C3 and C4, respectively) to reflect the processing of relevant information during unimodal tasks. 

<p style="text-align: justify;">
**Q4: (Unimodal conditions) Is beta power in the contralateral channel, i.e., C3 and C4, during movement and touch a neural marker for the processing of motor and tactile spatial information, respectively?**

H4: Beta power during movement and touch is lower than pre-movement (i.e., larger ERD) in the contralateral channel and less so in the ipsilateral channel.
</p>

<center style="color:#15925E;">**Is beta power in the contralateral channel during movement/touch a neural marker for the processing of motor/tactile spatial information?**</center>
```{r fig.width=15, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE}
# EEG ----
plotData = longData %>% 
  filter(timing %in% c("Movement Cue", "Before Movement", "Early Movement", "Half Movement", "Late Movement", "After Movement") & 
           unimodal == "Unimodal" & !is.na(relativehemisphere) & location %in% c("C3","C4")) %>%
  group_by(timing, condN, relativehemisphere, location) %>%
  get_summary_stats(powerBeta, show = c("ci", "mean", "sd"))

ggplot(plotData) +
  # geom_col(aes(x = condN, y = mean, group = timing, fill = timing) , position = "dodge")+
  geom_point(aes(x = timing, y = mean, color = condN))+
  geom_line(aes(x = timing, y = mean, color = condN, group = condN), linewidth = 3) +
  geom_errorbar(aes(x = timing, ymin = mean - ci, ymax = mean + ci, color = condN), width = .3) +
  geom_text(data = plotData %>% filter(timing == "Before Movement"),
            aes(x = timing, y = mean + mean * runif(6, min = -0.01, max = 0.03), label = location, color = condN),
            position = position_nudge(x = -0.3))+
  labs(
    title = "",
    x = "Timing",
    y = expression(Averaged ~ beta ~ Power ~ (mV^2))
  ) +
  scale_color_manual("Condition", values = palette$three.color2) +
  scale_fill_manual("Condition", values = palette$three.color2) +
  facet_wrap(~ relativehemisphere) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 16)
  )
```

<center style="color:#15925E;">**Is there ERD during movement and touch?**</center>

*Note*. This plot is placeholder only. This is not continuous data. Phuc will check back the latency.

```{r fig.width=15, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE}
# EEG: ERD normalized ----

byBaseline.shortData <- shortData %>%
  select(sbjN:absError, starts_with("C3"), starts_with("C4")) %>%
  mutate(C3_movcue = 100 * (C3_movcue - C3_pre) / C3_pre,
         C4_movcue = 100 * (C4_movcue - C4_pre) / C4_pre,
         
         C3_early = 100 * (C3_early - C3_pre) / C3_pre,
         C4_early = 100 * (C4_early - C4_pre) / C4_pre,
         
         C3_half = 100 * (C3_half - C3_pre) / C3_pre,
         C4_half = 100 * (C4_half - C4_pre) / C4_pre,
         
         C3_late  = 100 * (C3_late  - C3_pre) / C3_pre,
         C4_late  = 100 * (C4_late  - C4_pre) / C4_pre,
         C3_post  = 100 * (C3_post  - C3_pre) / C3_pre,
         C4_post  = 100 * (C4_post  - C4_pre) / C4_pre) %>%
  mutate(C3_pre = 0, C4_pre = 0)

byBaseline.longData <- long_beh_eeg_df(byBaseline.shortData)

plotData = byBaseline.longData %>% 
  filter(timing %in% c("Movement Cue", "Before Movement", "Early Movement", "Half Movement", "Late Movement", "After Movement") & unimodal == "Unimodal" & !is.na(relativehemisphere) & location %in% c("C3","C4")) %>%
  group_by(timing, condN, relativehemisphere, location) %>%
  get_summary_stats(powerBeta, show = c("ci", "mean", "sd"))

ggplot(plotData) +
  geom_point(aes(x = timing, y = mean, color = condN))+
  geom_line(aes(x = timing, y = mean, color = condN, group = condN), linewidth = 3) + 
  geom_errorbar(aes(x = timing, ymin = mean - ci, ymax = mean + ci, color = condN), width = .3) +
  # geom_text(data = plotData %>% filter(timing == "After Movement"), 
  #           aes(x = timing, y = mean + mean * runif(6, min = -0.5, max = .51), label = location, color = condN),
  #           position = position_nudge(x = 0.3))+
  labs(
    title = "",
    x = "Timing",
    y = "Power change (%)"
  ) +
  scale_color_manual("Condition", values = palette$three.color2) +
  scale_fill_manual("Condition", values = palette$three.color2) +
  facet_wrap(~ relativehemisphere) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 16)
  )

```

## Unimodal: Beta power for predicting motor/tactile percepts

<p style="text-align: justify;">
**Q5: Beta power during movement in contralateral channels could be associated with judgement of the length of movement and touch**

H5: Larger beta power in the contralateral channel during movement predicts smaller normalized absolute errors in judgement.
</p>

*Note* that normalized absolute error does not consider the direction of estimation (over/underestimate).

<center style="color:#15925E;">**Using Lower beta power for predicting judgement error**</center>
```{r fig.width=8, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}
plotData <- longData %>%
  filter(timing == "Late Movement" & unimodal == "Unimodal" & hemisphere != "mid" & location %in% c("C3", "C4"))

label_data <- plotData %>%
  group_by(condN, relativehemisphere, location) %>%
  filter(powerBeta == min(powerBeta)) %>%
  ungroup()

ggplot(
  plotData,
  aes(x = powerBeta, y = absError, color = condN)
) +
  geom_point(alpha = .1) +
  geom_smooth(method = "lm") +
  geom_text(
    data = label_data,
    aes(x = min(plotData$powerBeta), label = location),
    position = position_nudge(x = -0.05),
    show.legend = FALSE
    ) +
  facet_wrap(~relativehemisphere) +
  scale_color_manual("Condition", values = palette$three.color2) +
  labs(
    # title = "Beta Power at the Beginning and the End of the Experiment",
    x = expression(beta ~ Power ~ (mV^2)),
    y = "Perceptual Interference \n(Normalized Absolute Error)"
  ) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 16)
  )
```

<center style="color:#15925E;">**Does self-touch cause beta ERD? At which hemisphere and electrodes?**</center>


```{r fig.width=15, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE}
plotData = longData %>% 
  filter(timing %in% c("Movement Cue", "Before Movement", "Early Movement", "Half Movement", "Late Movement", "After Movement") & unimodal == "Self-touch" & !is.na(relativehemisphere)) %>%
  group_by(timing, condN, relativehemisphere) %>%
  get_summary_stats(powerBeta, show = c("ci", "mean", "sd"))

ggplot(plotData) +
  geom_point(aes(x = timing, y = mean, color = condN))+
  geom_line(aes(x = timing, y = mean, color = condN, group = condN), linewidth = 3) + 
  geom_errorbar(aes(x = timing, ymin = mean - ci, ymax = mean + ci, color = condN), width = .3) +
  labs(
    title = "",
    x = "Hemisphere",
    y = expression(Average ~ beta ~ Power ~ (mV^2))
  ) +
  scale_color_manual("Condition", values = palette$four.color1) +
  scale_fill_manual("Condition", values = palette$four.color1) +
  facet_wrap(~ relativehemisphere) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 16)
  )
```

<center style="color:#15925E;">**Is there ERD during movement and touch?**</center>

*Note*. This plot is placeholder only because it does not visualize continuous data. Phuc will check the latency.

```{r fig.width=15, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE}
# EEG: ERD normalized ----

plotData = byBaseline.longData %>% 
  filter(timing %in% c("Movement Cue", "Before Movement", "Early Movement", "Half Movement", "Late Movement", "After Movement") & unimodal == "Self-touch" & !is.na(relativehemisphere) & location %in% c("C3","C4")) %>%
  group_by(timing, condN, relativehemisphere, location) %>%
  get_summary_stats(powerBeta, show = c("ci", "mean", "sd"))

ggplot(plotData) +
  geom_point(aes(x = timing, y = mean, color = condN))+
  geom_line(aes(x = timing, y = mean, color = condN, group = condN), linewidth = 3) + 
  geom_errorbar(aes(x = timing, ymin = mean - ci, ymax = mean + ci, color = condN), width = .3) +
  # geom_text(data = plotData %>% filter(timing == "After Movement"), 
  #           aes(x = timing, y = mean + mean * runif(6, min = -0.5, max = .51), label = location, color = condN),
  #           position = position_nudge(x = 0.3))+
  labs(
    title = "",
    x = "Timing",
    y = "Power change (%)"
  ) +
  scale_color_manual("Condition", values = palette$four.color1) +
  scale_fill_manual("Condition", values = palette$four.color1) +
  facet_wrap(~ relativehemisphere) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 16)
  )

```

## Self-touch: Interhemispheric interference


  - **Normalized Absolute Error** quantifies *perceptual interference*, i.e., the degree to which the perceptual judgement deviates from the true value OR how much the perceptual judgement is interfered by other information.
  
  $$Perceptual Inference = |1-\frac{reported length}{true length}\ |$$
  
  - **Beta Power Difference** between the left hemisphere (C3) and the right hemisphere (C4) represents the degree to which motor activity interferes with tactile processing. Positive difference implies weaker interference of motor information (tactile focus), while negative difference implies stronger interference of motor information (motor focus).
  
  $$\Delta{B} = B_{C3} - B_{C4}$$
  
  - **Beta Power Sum** of the left hemisphere (C3) and the right hemisphere (C4) represents the global beta power that implies participants' wakefulness. Lower global beta power is associated with increased wakefulness
  
  $$\sum{B} = B_{C3} + B_{C4}$$
  

Because movement and tactile spatial percepts during self-touch are interfered by the processing of tactile and movement information, respectively, we expect that the neural marker of these two components could be used to predict judgement accuracy. For example, a negative difference in beta power between C3 and C4 *(C3 - C4)* reflects larger processing of motor information relative to tactile information and may suggest that motor information is weighted more in length judgement than tactile judgement

<p style="text-align: justify;">

**Q6: (Self-touch conditions) Does the relative difference in beta power between channel C3 and C4 during self-touch explain the asymmetrical, bidirectional interference of movement and tactile spatial percepts?**
H6: Negative difference in the beta power between the channels C3 and C4 [C3-C4] (i.e., stronger motor processing than tactile processing) is associated with smaller error in move judgement and smaller tactile judgement.


</p>

<center style="color:#15925E;">**Beta power difference for predicting judgement error**</center>

```{r fig.width=8, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}

plotData = shortData %>%
  filter(unimodal == "Self-touch" & gain != 1)

ggplot(plotData,
       aes(x = C3_early-C4_early, y = absError, color = task))+
  geom_point(alpha = .05)+
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~mov)+
  labs(
    title = "Difference of Beta Power During Early Movement",
    x = "Beta Power Difference: C3 - C4",
    y = "Perceptual Interference \n(Normalized Absolute Error)"
  ) +
  scale_color_manual("Task", values = palette$two.color1) +
  facet_wrap(~mov) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16)
  )

```



```{r fig.width=8, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}

plotData = shortData %>%
  filter(unimodal == "Self-touch" & gain!= 1)

ggplot(plotData,
       aes(x = C3_late-C4_late, y = absError, color = task))+
  geom_point(alpha = .05)+
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~mov)+
  labs(
    title = "Difference of Beta Power During Late Movement",
    x = "Beta Power Difference: C3 - C4",
    y = "Perceptual Interference \n(Normalized Absolute Error)"
  ) +
  scale_color_manual("Task", values = palette$two.color1) +
  facet_wrap(~mov) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16)
  )

```

```{r fig.width=8, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}

plotData = byBaseline.shortData %>%
  filter(unimodal == "Self-touch" & gain != 1)

ggplot(plotData,
       aes(x = C3_early-C4_early, y = absError, color = task))+
  geom_point(alpha = .05)+
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~mov)+
  labs(
    title = "Difference of Desynchornization During Early Movement",
    x = "ERD Difference: C3 - C4",
    y = "Perceptual Interference \n(Normalized Absolute Error)"
  ) +
  scale_color_manual("Task", values = palette$two.color1) +
  facet_wrap(~mov) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16)
  )

```


```{r fig.width=8, fig.height=5, echo=FALSE, warning=FALSE, message=FALSE}

plotData = byBaseline.shortData %>%
  filter(unimodal == "Self-touch" & gain != 1)

ggplot(plotData,
       aes(x = C3_late-C4_late, y = absError, color = task))+
  geom_point(alpha = .05)+
  geom_smooth(method = "lm") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~mov)+
  labs(
    title = "Difference of Desynchornization During Late Movement",
    x = "ERD Difference: C3 - C4",
    y = "Perceptual Interference \n(Normalized Absolute Error)"
  ) +
  scale_color_manual("Task", values = palette$two.color1) +
  facet_wrap(~mov) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(size = 16),
    plot.title = element_text(size = 19),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16)
  )

```
